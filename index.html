<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Spotify Bill — Top 20</title>
  <style>
    :root{
      --bg:#070707;
      --panel:#393536;
      --accent:#1DB954; /* Spotify green */
      --muted:#bdb6b6;
      --glass: rgba(255,255,255,0.03);
      font-family: 'Segoe UI', Roboto, Arial, sans-serif;
    }
    html,body{height:100%;margin:0;background:var(--bg);color:#fff}
    .wrap{max-width:1100px;margin:40px auto;padding:36px}

    header{display:flex;flex-direction:column;gap:18px;align-items:center}
    h1{color:var(--accent);font-weight:600;letter-spacing:2px;font-size:48px;margin:0}
    .input-row{width:100%;display:flex;gap:12px;align-items:center}
    input[type=text]{flex:1;padding:14px 18px;background:var(--panel);border:0;border-radius:3px;color:#ddd}
    .muted{color:var(--muted);font-size:13px}
    button{background:var(--accent);border:0;padding:12px 16px;border-radius:4px;color:#03150b;font-weight:700;cursor:pointer}
    .controls{display:flex;gap:10px;align-items:center}

    .card{margin-top:26px;background:var(--panel);padding:12px;border-radius:4px;box-shadow:0 8px 30px rgba(0,0,0,0.6)}
    .table{width:100%;border-collapse:collapse}
    thead th{background:transparent;color:var(--accent);padding:14px;border-bottom:1px solid rgba(0,0,0,0.4);text-align:left}
    tbody td{padding:14px;border-bottom:1px dashed rgba(255,255,255,0.04);vertical-align:middle}
    .thumb{height:48px;width:48px;border-radius:4px;object-fit:cover;margin-right:10px}
    .songrow{display:flex;align-items:center}
    .rank{width:28px;color:var(--muted)}
    .small{font-size:13px;color:var(--muted)}
    .download{margin-left:auto}

    .empty{padding:40px;text-align:center;color:var(--muted)}

    @media(max-width:800px){h1{font-size:32px}.wrap{padding:20px}}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>SPOTIFY BILL</h1>
      <div class="input-row">
        <input id="profileUrl" type="text" placeholder="ENTER YOUR SPOTIFY PROFILE URL (optional) — or click Connect Spotify" />
        <div class="controls">
          <button id="connect">Connect Spotify</button>
          <button id="generate" disabled>Generate Bill</button>
          <button id="download" class="download" disabled>Download CSV</button>
        </div>
      </div>
      <div class="muted">This page will ask you to connect to Spotify (you must grant permission). We then fetch your top 20 listened tracks and show an estimate. See notes below.</div>
    </header>

    <section class="card" id="result">
      <div id="status" class="empty">No bill yet — connect your Spotify account and click "Generate Bill".</div>
      <table id="table" class="table" style="display:none">
        <thead>
          <tr>
            <th></th>
            <th>SONG</th>
            <th>ARTIST</th>
            <th>Genre</th>
            <th>Mins Played (est.)</th>
            <th>Times played (est.)</th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
      <div style="margin-top:12px;color:var(--muted);font-size:13px">
        Notes: Spotify's Web API provides a user's top tracks but it does NOT give exact per-user play counts. This tool shows your top 20 (ranked) and uses your recent plays (last 50 items) to estimate "times played" and minutes listened when possible. Estimates are limited by Spotify API data.
      </div>
    </section>
  </div>

<script>
// --------------------
// Configuration / setup
// --------------------
// You MUST register an app at https://developer.spotify.com/dashboard and add the redirect URI where you will host this page.
// Put the client id of your app here.
const CLIENT_ID = '285cd2238c0c43288db034fa778abc80'; // <-- replace
const REDIRECT_URI = window.location.origin + window.location.pathname; // make sure this is allowed in app settings
const SCOPES = 'user-top-read user-read-recently-played';

// --------------------
// PKCE helpers
// --------------------
function base64urlencode(str) {
  return btoa(String.fromCharCode.apply(null, new Uint8Array(str)))
    .replace(/\+/g, '-')
    .replace(/\//g, '_')
    .replace(/=+$/, '');
}
async function sha256(plain) {
  const encoder = new TextEncoder();
  const data = encoder.encode(plain);
  return await crypto.subtle.digest('SHA-256', data);
}
async function generateCodeChallenge(code_verifier) {
  const hashed = await sha256(code_verifier);
  return base64urlencode(hashed);
}
function generateRandomString(length) {
  const array = new Uint8Array(length);
  crypto.getRandomValues(array);
  return Array.from(array, dec=>('0'+dec.toString(16)).substr(-2)).join('');
}

// --------------------
// OAuth flow
// --------------------
async function startAuth() {
  const code_verifier = generateRandomString(64);
  const code_challenge = await generateCodeChallenge(code_verifier);
  sessionStorage.setItem('code_verifier', code_verifier);

  const params = new URLSearchParams({
    client_id: CLIENT_ID,
    response_type: 'code',
    redirect_uri: REDIRECT_URI,
    code_challenge_method: 'S256',
    code_challenge,
    scope: SCOPES,
  });
  const url = `https://accounts.spotify.com/authorize?${params.toString()}`;
  window.location = url;
}

async function handleRedirect() {
  const url = new URL(window.location);
  const code = url.searchParams.get('code');
  const error = url.searchParams.get('error');
  if (error) {
    alert('Spotify auth error: ' + error);
  }
  if (!code) return null;
  // exchange code for token
  const code_verifier = sessionStorage.getItem('code_verifier');
  const body = new URLSearchParams({
    grant_type: 'authorization_code',
    code,
    redirect_uri: REDIRECT_URI,
    client_id: CLIENT_ID,
    code_verifier
  });
  const resp = await fetch('https://accounts.spotify.com/api/token', {
    method: 'POST', headers: {'Content-Type':'application/x-www-form-urlencoded'}, body
  });
  const data = await resp.json();
  if (data.error) { alert('Token error: '+data.error); return null }
  // save
  sessionStorage.setItem('access_token', data.access_token);
  sessionStorage.setItem('refresh_token', data.refresh_token || '');
  // clean url
  url.searchParams.delete('code');
  history.replaceState({}, document.title, url.pathname);
  return data.access_token;
}

async function ensureToken() {
  let token = sessionStorage.getItem('access_token');
  if (token) return token;
  token = await handleRedirect();
  return token;
}

// --------------------
// Spotify helpers
// --------------------
async function sfetch(endpoint, token, opts={}){
  const res = await fetch('https://api.spotify.com/v1'+endpoint, {headers:{'Authorization':'Bearer '+token}, ...opts});
  if (!res.ok) throw new Error('Spotify API error: '+res.status);
  return await res.json();
}

function msToMinutes(ms){return (ms/60000).toFixed(1)}

// --------------------
// UI and data flow
// --------------------
const connectBtn = document.getElementById('connect');
const genBtn = document.getElementById('generate');
const downloadBtn = document.getElementById('download');
const status = document.getElementById('status');
const tbody = document.getElementById('tbody');
const table = document.getElementById('table');

connectBtn.addEventListener('click', async ()=>{
  if (!CLIENT_ID || CLIENT_ID.includes('<YOUR')){
    alert('Please set your Spotify client id in the script before using this page. See the top of the HTML file.');
    return;
  }
  await startAuth();
});

genBtn.addEventListener('click', generateBill);

downloadBtn.addEventListener('click', ()=>{
  const csv = buildCSV(currentTracks);
  const blob = new Blob([csv], {type:'text/csv'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = 'spotify-bill.csv';
  document.body.appendChild(a);a.click();a.remove();
});

let currentTracks = [];

async function generateBill(){
  try{
    genBtn.disabled = true; status.textContent='Fetching token...';
    const token = await ensureToken();
    if (!token) { status.textContent='Authentication required.'; genBtn.disabled=false; return }
    status.textContent='Fetching top tracks...';
    const top = await sfetch('/me/top/tracks?limit=20', token);
    // fetch recently played to estimate counts (last 50 plays only)
    status.textContent='Fetching recent plays (estimates)...';
    let recent = {items:[]};
    try{ recent = await sfetch('/me/player/recently-played?limit=50', token); }catch(e){/*ignore*/}
    const counts = {};
    recent.items.forEach(it=>{ const id = it.track.id; counts[id] = (counts[id]||0)+1 });

    // fetch genres from primary artist
    status.textContent='Fetching artist genres...';
    const enhanced = await Promise.all(top.items.map(async (t,idx)=>{
      let genre='';
      try{
        const artist = await sfetch('/artists/'+t.artists[0].id, token);
        genre = (artist.genres && artist.genres.length)?artist.genres[0]:'—';
      }catch(e){genre='—'}
      const times = counts[t.id] || 0;
      const mins = (times>0) ? (msToMinutes(t.duration_ms*times)) : '—';
      return {
        rank: idx+1,
        id: t.id,
        name: t.name,
        artists: t.artists.map(a=>a.name).join(', '),
        genre,
        duration_ms: t.duration_ms,
        times_played_est: times,
        mins_played_est: mins,
        thumbnail: t.album.images && t.album.images[0] ? t.album.images[0].url : ''
      }
    }));

    currentTracks = enhanced;
    renderTable(enhanced);
    status.style.display='none'; table.style.display='table'; downloadBtn.disabled=false; genBtn.disabled=false;
  }catch(err){
    console.error(err); status.textContent='Error: '+err.message; genBtn.disabled=false;
  }
}

function renderTable(list){
  tbody.innerHTML='';
  list.forEach(item=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td class="rank">${item.rank}.</td>
      <td>
        <div class="songrow"><img src="${item.thumbnail}" class="thumb" onerror="this.style.display='none'">
        <div><div>${item.name}</div><div class="small">${msToMinutes(item.duration_ms)} min</div></div></div>
      </td>
      <td>${item.artists}</td>
      <td>${item.genre}</td>
      <td>${item.mins_played_est}</td>
      <td>${item.times_played_est}</td>
    `;
    tbody.appendChild(tr);
  })
}

function buildCSV(list){
  const rows = [['Rank','Song','Artist','Genre','Mins Played (est.)','Times Played (est.)']];
  list.forEach(r=>rows.push([r.rank, r.name, r.artists, r.genre, r.mins_played_est, r.times_played_est]));
  return rows.map(r=>r.map(c=>`"${String(c).replace(/"/g,'""')}"`).join(',')).join('\n');
}

// --------------------
// On load: enable generate if already authed
// --------------------
(async ()=>{
  const token = sessionStorage.getItem('access_token');
  if (token) genBtn.disabled=false;
  // If we arrived with ?code=... attempt token exchange automatically
  const url = new URL(window.location);
  if (url.searchParams.get('code')){
    await handleRedirect();
    genBtn.disabled=false;
  }
})();
</script>
</body>
</html>
